---
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogPreview from "../../components/BlogPreview.astro";
import { getCollection, type CollectionEntry } from "astro:content";

// 1. å–å¾—æ‰€æœ‰æ–‡ç« ä¸¦ä¾ç…§ã€Œç½®é ‚ã€èˆ‡ã€Œæ—¥æœŸã€æ’åº
const allPosts = (await getCollection("blog")).sort((a, b) => {
    // æ¢ä»¶ä¸€ï¼šå…ˆæ¯”å°ç½®é ‚ç‹€æ…‹ (featured: true çš„æ’åœ¨å‰é¢)
    const isAFeatured = a.data.featured === true;
    const isBFeatured = b.data.featured === true;

    if (isAFeatured && !isBFeatured) return -1;
    if (!isAFeatured && isBFeatured) return 1;

    // æ¢ä»¶äºŒï¼šè‹¥ç½®é ‚ç‹€æ…‹ç›¸åŒï¼ˆéƒ½æ˜¯ true æˆ–éƒ½æ˜¯ falseï¼‰ï¼Œå‰‡ä¾ç…§æ—¥æœŸæ’åº (æ–° -> èˆŠ)
    const dateB = (
        b.data.updatedDate ??
        b.data.lastMod ??
        b.data.pubDate
    ).valueOf();
    const dateA = (
        a.data.updatedDate ??
        a.data.lastMod ??
        a.data.pubDate
    ).valueOf();
    return dateB - dateA;
});

// 2. æå–æ‰€æœ‰æ¨™ç±¤ä¸¦è¨ˆç®—å‡ºç¾æ¬¡æ•¸ (æ”¹ç”¨ Map)
const tagCounts = new Map<string, number>();
allPosts.forEach((post) => {
    if (post.data.tags) {
        post.data.tags.forEach((tag) => {
            // å¦‚æœæ¨™ç±¤å·²ç¶“å­˜åœ¨å°± +1ï¼Œä¸å­˜åœ¨å°±è¨­ç‚º 1
            tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
        });
    }
});

// 3. æ¨™ç±¤æ’åºé‚è¼¯ (å„ªå…ˆæ¨™ç±¤ -> å‡ºç¾æ¬¡æ•¸é«˜åˆ°ä½ -> ç­†ç•«é †åº)
const priorityTags = ["è¡›æ•™æ–‡ç« ", "é™¢é•·ç¶“é©—è«‡", "åª’é«”å ±å°"];
const sortedTags = Array.from(tagCounts.keys()).sort((a, b) => {
    // æ¢ä»¶ä¸€ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºã€Œå„ªå…ˆä¿ç•™æ¨™ç±¤ã€
    const indexA = priorityTags.indexOf(a);
    const indexB = priorityTags.indexOf(b);
    if (indexA !== -1 && indexB !== -1) return indexA - indexB;
    if (indexA !== -1) return -1;
    if (indexB !== -1) return 1;

    // æ¢ä»¶äºŒï¼šä¾ç…§ã€Œå‡ºç¾æ¬¡æ•¸ã€ç”±é«˜åˆ°ä½æ’åº
    const countA = tagCounts.get(a) || 0;
    const countB = tagCounts.get(b) || 0;
    if (countA !== countB) {
        return countB - countA; // æ•¸å­—å¤§çš„æ’å‰é¢
    }

    // æ¢ä»¶ä¸‰ï¼šå¦‚æœå‡ºç¾æ¬¡æ•¸ä¸€æ¨£ï¼Œå‰‡ä¾ç…§å­—é¦–ç­†ç•«/å­—æ¯æ’åº
    return a.localeCompare(b);
});
---

<BaseLayout title="è¡›æ•™å°ˆæ¬„èˆ‡æœ€æ–°æ¶ˆæ¯ | è¬æ˜ç¦å¾©å¥ç§‘è¨ºæ‰€">
    <header
        class="bg-gradient-to-br from-primary via-[#004b82] to-primary-dark pt-20 pb-16 mb-10 shadow-inner relative overflow-hidden"
    >
        <div
            class="absolute top-0 left-0 w-full h-full overflow-hidden z-0 opacity-10 pointer-events-none"
        >
            <svg
                class="absolute -top-24 -right-24 w-96 h-96 text-white"
                fill="currentColor"
                viewBox="0 0 100 100"
                ><circle cx="50" cy="50" r="50"></circle></svg
            >
            <svg
                class="absolute top-1/2 -left-12 w-48 h-48 text-white"
                fill="currentColor"
                viewBox="0 0 100 100"
                ><circle cx="50" cy="50" r="50"></circle></svg
            >
        </div>

        <div class="max-w-4xl mx-auto px-4 text-center relative z-10">
            <h1
                class="text-4xl md:text-5xl font-extrabold text-white mb-6 tracking-tight drop-shadow-md"
            >
                è¡›æ•™å°ˆæ¬„èˆ‡æœ€æ–°æ¶ˆæ¯
            </h1>
            <p
                class="text-lg md:text-xl text-blue-50 leading-relaxed max-w-2xl mx-auto opacity-90"
            >
                ç”±è¬æ˜ç¦é™¢é•·è¦ªè‡ªæ’°å¯«èˆ‡å¯©é–±ï¼Œç‚ºæ‚¨æä¾›æœ€å°ˆæ¥­çš„å¾©å¥é†«å­¸çŸ¥è­˜ã€å±…å®¶ä¿å¥æŒ‡å—èˆ‡è¨ºæ‰€æœ€æ–°å‹•æ…‹ã€‚
            </p>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 mb-12 relative">
        <div class="flex items-start gap-2">
            <div class="relative flex-grow overflow-hidden">
                <div
                    id="gradient-left"
                    class="absolute left-0 top-0 bottom-0 w-8 bg-gradient-to-r from-white to-transparent z-10 pointer-events-none md:hidden transition-opacity duration-300"
                >
                </div>
                <div
                    id="gradient-right"
                    class="absolute right-0 top-0 bottom-0 w-12 bg-gradient-to-l from-white to-transparent z-10 pointer-events-none md:hidden transition-opacity duration-300"
                >
                </div>

                <div
                    id="tags-container"
                    class="flex flex-nowrap overflow-x-auto gap-3 pb-2 pt-1 px-1 scrollbar-hide snap-x transition-all duration-300"
                >
                    <button
                        class="filter-btn active flex-shrink-0 snap-start bg-primary text-white border border-primary px-5 py-2 rounded-full text-sm font-semibold transition-all shadow-sm"
                        data-tag="all"
                    >
                        å…¨éƒ¨æ–‡ç« 
                    </button>
                    {
                        sortedTags.map((tag) => (
                            <button
                                class="filter-btn flex-shrink-0 snap-start bg-white text-gray-600 border border-gray-200 px-5 py-2 rounded-full text-sm font-medium hover:bg-primary-light hover:text-primary hover:border-primary-light transition-all"
                                data-tag={tag}
                            >
                                {tag}
                            </button>
                        ))
                    }
                </div>
            </div>

            <button
                id="toggle-tags-btn"
                class="flex-shrink-0 mt-1 w-9 h-9 flex items-center justify-center rounded-full bg-white text-gray-500 hover:bg-primary-light hover:text-primary transition-colors border border-gray-200 shadow-sm z-20"
                aria-label="å±•é–‹æ‰€æœ‰æ¨™ç±¤"
            >
                <svg
                    id="chevron-icon"
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="transition-transform duration-300"
                >
                    <path d="m6 9 6 6 6-6"></path>
                </svg>
            </button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 pb-20">
        <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8"
            id="post-grid"
        >
            {
                allPosts.map((post) => (
                    <div
                        class="post-item"
                        data-tags={JSON.stringify(post.data.tags || [])}
                    >
                        <BlogPreview post={post} />
                    </div>
                ))
            }
        </div>

        <div id="no-results" class="hidden text-center py-20">
            <div
                class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 text-gray-400 mb-4"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="32"
                    height="32"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><circle cx="11" cy="11" r="8"></circle><path
                        d="m21 21-4.3-4.3"></path></svg
                >
            </div>
            <h3 class="text-xl font-bold text-gray-700 mb-2">
                æ‰¾ä¸åˆ°ç›¸é—œæ¨™ç±¤çš„æ–‡ç« 
            </h3>
            <p class="text-gray-500">
                è«‹å˜—è©¦é»æ“Šå…¶ä»–æ¨™ç±¤ï¼Œæˆ–æŸ¥çœ‹ã€Œå…¨éƒ¨æ–‡ç« ã€ã€‚
            </p>
        </div>
    </div>
</BaseLayout>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const filterBtns = document.querySelectorAll(".filter-btn");
        const postItems = document.querySelectorAll(".post-item");
        const noResults = document.getElementById("no-results");
        // ğŸ‘‡ æ–°å¢é€™æ®µï¼šæ¨™ç±¤å±•é–‹/æ”¶åˆé‚è¼¯
        const toggleTagsBtn = document.getElementById("toggle-tags-btn");
        const tagsContainer = document.getElementById("tags-container");
        const chevronIcon = document.getElementById("chevron-icon");
        const gradientLeft = document.getElementById("gradient-left");
        const gradientRight = document.getElementById("gradient-right");

        let isTagsExpanded = false;

        if (toggleTagsBtn && tagsContainer) {
            toggleTagsBtn.addEventListener("click", () => {
                isTagsExpanded = !isTagsExpanded;

                if (isTagsExpanded) {
                    // å±•é–‹ç‹€æ…‹ï¼šå…è¨±æ›è¡Œ (flex-wrap)ã€å–æ¶ˆæ©«å‘æ»¾å‹• (overflow-x-auto)
                    tagsContainer.classList.remove(
                        "flex-nowrap",
                        "overflow-x-auto",
                        "snap-x",
                        "scrollbar-hide",
                    );
                    tagsContainer.classList.add("flex-wrap");
                    // ç®­é ­æ—‹è½‰ 180 åº¦æœä¸Š
                    chevronIcon.classList.add("rotate-180");
                    // éš±è—æ¼¸å±¤é®ç½©
                    if (gradientLeft) gradientLeft.style.opacity = "0";
                    if (gradientRight) gradientRight.style.opacity = "0";
                } else {
                    // æ”¶åˆç‹€æ…‹ï¼šæ¢å¾©å–®è¡Œæ©«å‘æ»¾å‹•
                    tagsContainer.classList.remove("flex-wrap");
                    tagsContainer.classList.add(
                        "flex-nowrap",
                        "overflow-x-auto",
                        "snap-x",
                        "scrollbar-hide",
                    );
                    // ç®­é ­æ¢å¾©æœä¸‹
                    chevronIcon.classList.remove("rotate-180");
                    // æ¢å¾©æ¼¸å±¤é®ç½©
                    if (gradientLeft) gradientLeft.style.opacity = "1";
                    if (gradientRight) gradientRight.style.opacity = "1";
                }
            });
        }

        filterBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                // æŒ‰éˆ•æ¨£å¼åˆ‡æ›
                filterBtns.forEach((b) => {
                    b.classList.remove(
                        "active",
                        "bg-primary",
                        "text-white",
                        "border-primary",
                        "shadow-sm",
                    );
                    b.classList.add(
                        "bg-white",
                        "text-gray-600",
                        "border-gray-200",
                    );
                });

                btn.classList.remove(
                    "bg-white",
                    "text-gray-600",
                    "border-gray-200",
                );
                btn.classList.add(
                    "active",
                    "bg-primary",
                    "text-white",
                    "border-primary",
                    "shadow-sm",
                );

                const selectedTag = btn.getAttribute("data-tag");
                let visibleCount = 0;

                // ç¯©é¸æ–‡ç« 
                postItems.forEach((item) => {
                    const tags = JSON.parse(
                        item.getAttribute("data-tags") || "[]",
                    );
                    if (selectedTag === "all" || tags.includes(selectedTag)) {
                        (item as HTMLElement).style.display = "block";
                        (item as HTMLElement).style.animation =
                            "fadeIn 0.5s ease";
                        visibleCount++;
                    } else {
                        (item as HTMLElement).style.display = "none";
                    }
                });

                // é¡¯ç¤ºç„¡çµæœç‹€æ…‹
                if (visibleCount === 0 && noResults) {
                    noResults.classList.remove("hidden");
                } else if (noResults) {
                    noResults.classList.add("hidden");
                }
            });
        });
    });
</script>

<style>
    /* éš±è—æ©«å‘æ»¾å‹•æ¢ï¼Œä½†ä¿ç•™æ»‘å‹•åŠŸèƒ½ */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
