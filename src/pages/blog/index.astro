---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { CATEGORY_MAP } from '../../consts.ts';

// 1. Get all posts and sort (é‚è¼¯ä¸è®Š)
const allPosts: CollectionEntry<'blog'>[] = (await getCollection('blog')).sort(
    (a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => {
        const dateB = (b.data.lastMod ? b.data.lastMod : b.data.pubDate).valueOf();
        const dateA = (a.data.lastMod ? a.data.lastMod : a.data.pubDate).valueOf();
        return dateB - dateA;
    }
);

// --------------------------------------------------------
// (ğŸ‘‡ é—œéµä¿®æ­£ï¼šå¾ 'post.id.startsWith' æ”¹ç‚º 'post.data.category ===')
// --------------------------------------------------------
const healthPosts = allPosts.filter(post => post.data.category === 'health');
const reportPosts = allPosts.filter(post => post.data.category === 'reports');
const directorPosts = allPosts.filter(post => post.data.category === 'director');

// (ğŸ‘‡ ç‚ºäº†å®‰å…¨èµ·è¦‹ï¼Œæˆ‘å€‘ä¹Ÿä¿®æ”¹ 'otherPosts' çš„é‚è¼¯)
const otherPosts = allPosts.filter(post => 
    !post.data.category || // æŠ“å‡ºæœªåˆ†é¡çš„
    (post.data.category !== 'health' &&
     post.data.category !== 'reports' &&
     post.data.category !== 'director')
);
// --------------------------------------------------------
// (ğŸ‘† ä¿®æ­£çµæŸ)
// --------------------------------------------------------

// 4. Split each category into "Latest" (1) and "Remaining" (up to 4)
const latestHealthPost = healthPosts[0];
const remainingHealthPosts = healthPosts.slice(1, 5); 

const latestReportPost = reportPosts[0];
const remainingReportPosts = reportPosts.slice(1, 5);

const latestDirectorPost = directorPosts[0];
const remainingDirectorPosts = directorPosts.slice(1, 5);

const latestOtherPost = otherPosts[0];
const remainingOtherPosts = otherPosts.slice(1, 5);

// Helper function (é‚è¼¯ä¸è®Š)
const getDisplayDate = (post: CollectionEntry<'blog'>) => {
    return post.data.lastMod ?? post.data.pubDate;
};
const hasBeenUpdated = (post: CollectionEntry<'blog'>) => {
    return post.data.lastMod ? true : false;
};
---

<BaseLayout title="å°ˆæ¬„æ–‡ç« ï½œè¬æ˜ç¦å¾©å¥ç§‘è¨ºæ‰€" description="è¬æ˜ç¦å¾©å¥ç§‘è¨ºæ‰€æœ€æ–°è¡›æ•™è³‡è¨Šã€æ–‡ç« èˆ‡åª’é«”å ±å°ã€‚">

    <section id="blog-hero">
        <h1>å¾©å¥æ–°çŸ¥ï¼ç–¼ç—›æ²»ç™‚å°ˆæ¬„</h1>
        <p>æœ€æ–°çš„å¾©å¥çŸ¥è­˜ã€ç–¼ç—›æ²»ç™‚æ–°çŸ¥èˆ‡åª’é«”å°ˆè¨ª</p>
    </section>

    <section id="blog-list" style="padding: 4rem 1rem;">
        <div class="container" style="max-width: 900px; margin: 0 auto;">

            {latestHealthPost && (
                <>
                    <h2 class="category-title">{CATEGORY_MAP.health}</h2>
                    <div class="category-layout">
                        
                        <a href={`/blog/${latestHealthPost.slug}/`} class="featured-card post-card">
                            {latestHealthPost.data.heroImage && (
                                <img src={latestHealthPost.data.heroImage} alt={latestHealthPost.data.title} class="card-image">
                            )}
                            <div class="card-content">
                                <h3>{latestHealthPost.data.title}</h3>
                                <p>{latestHealthPost.data.description}</p>
                                <span class="card-date">
                                    {hasBeenUpdated(latestHealthPost) && <span class="update-badge">(å·²æ›´æ–°) </span>}
                                    {getDisplayDate(latestHealthPost).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                        </a>

                        <div class="list-container">
                            {remainingHealthPosts.map(post => (
                                <a href={`/blog/${post.slug}/`} class="list-item">
                                    <div class="list-item-content">
                                        <h3>{post.data.title}</h3>
                                        <span class="list-item-date">
                                            {hasBeenUpdated(post) && <span class="update-badge">(å·²æ›´æ–°) </span>}
                                            {getDisplayDate(post).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                        </span>
                                    </div>
                                </a>
                            ))}
                        </div>

                        {healthPosts.length > 5 && (
                            <div class="view-all-container">
                                <a href={`/blog/health`} class="view-all-link">
                                    æŸ¥çœ‹æ‰€æœ‰ã€Œ{CATEGORY_MAP.health}ã€æ–‡ç«  &rarr;
                                </a>
                            </div>
                        )}

                    </div>
                </>
            )}

            {latestReportPost && (
                <>
                    <h2 class="category-title">{CATEGORY_MAP.reports}</h2>
                    <div class="category-layout">
                        <a href={`/blog/${latestReportPost.slug}/`} class="featured-card post-card">
                            {latestReportPost.data.heroImage && (
                                <img src={latestReportPost.data.heroImage} alt={latestReportPost.data.title} class="card-image">
                            )}
                            <div class="card-content">
                                <h3>{latestReportPost.data.title}</h3>
                                <p>{latestReportPost.data.description}</p>
                                <span class="card-date">
                                    {hasBeenUpdated(latestReportPost) && <span class="update-badge">(å·²æ›´æ–°) </span>}
                                    {getDisplayDate(latestReportPost).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                        </a>
                        <div class="list-container">
                            {remainingReportPosts.map(post => (
                                <a href={`/blog/${post.slug}/`} class="list-item">
                                    <div class="list-item-content">
                                        <h3>{post.data.title}</h3>
                                        <span class="list-item-date">
                                            {hasBeenUpdated(post) && <span class="update-badge">(å·²æ›´æ–°) </span>}
                                            {getDisplayDate(post).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                        </span>
                                    </div>
                                </a>
                            ))}
                        </div>

                        {reportPosts.length > 5 && (
                            <div class="view-all-container">
                                <a href={`/blog/reports`} class="view-all-link">
                                    æŸ¥çœ‹æ‰€æœ‰ã€Œ{CATEGORY_MAP.reports}ã€æ–‡ç«  &rarr;
                                </a>
                            </div>
                        )}

                    </div>
                </>
            )}

            {latestDirectorPost && (
                <>
                    <h2 class="category-title">{CATEGORY_MAP.director}</h2>
                    <div class="category-layout">
                        <a href={`/blog/${latestDirectorPost.slug}/`} class="featured-card post-card">
                            {latestDirectorPost.data.heroImage && (
                                <img src={latestDirectorPost.data.heroImage} alt={latestDirectorPost.data.title} class="card-image">
                            )}
                            <div class="card-content">
                                <h3>{latestDirectorPost.data.title}</h3>
                                <p>{latestDirectorPost.data.description}</p>
                                <span class="card-date">
                                    {hasBeenUpdated(latestDirectorPost) && <span class="update-badge">(å·²æ›´æ–°) </span>}
                                    {getDisplayDate(latestDirectorPost).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                        </a>
                        <div class="list-container">
                            {remainingDirectorPosts.map(post => (
                                <a href={`/blog/${post.slug}/`} class="list-item">
                                    <div class="list-item-content">
                                        <h3>{post.data.title}</h3>
                                        <span class="list-item-date">
                                            {hasBeenUpdated(post) && <span class="update-badge">(å·²æ›´æ–°) </span>}
                                            {getDisplayDate(post).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                        </span>
                                    </div>
                                </a>
                            ))}
                        </div>

                        {directorPosts.length > 5 && (
                            <div class="view-all-container">
                                <a href={`/blog/director`} class="view-all-link">
                                    æŸ¥çœ‹æ‰€æœ‰ã€Œ{CATEGORY_MAP.director}ã€æ–‡ç«  &rarr;
                                </a>
                            </div>
                        )}

                    </div>
                </>
            )}
            
            {latestOtherPost && (
                <>
                    <h2 class="category-title">å…¶ä»–æ–‡ç« </h2>
                    <div class="category-layout">
                        <a href={`/blog/${latestOtherPost.slug}/`} class="featured-card post-card">
                            {latestOtherPost.data.heroImage && (
                                <img src={latestOtherPost.data.heroImage} alt={latestOtherPost.data.title} class="card-image">
                            )}
                            <div class="card-content">
                                <h3>{latestOtherPost.data.title}</h3>
                                <p>{latestOtherPost.data.description}</p>
                                <span class="card-date">
                                    {hasBeenUpdated(latestOtherPost) && <span class="update-badge">(å·²æ›´æ–°) </span>}
                                    {getDisplayDate(latestOtherPost).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                        </a>
                        <div class="list-container">
                            {remainingOtherPosts.map(post => (
                                <a href={`/blog/${post.slug}/`} class="list-item">
                                    <div class="list-item-content">
                                        <h3>{post.data.title}</h3>
                                        <span class="list-item-date">
                                            {hasBeenUpdated(post) && <span class="update-badge">(å·²æ›´æ–°) </span>}
                                            {getDisplayDate(post).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                        </span>
                                    </div>
                                </a>
                            ))}
                        </div>

                        {reportPosts.length > 5 && (
                            <div class="view-all-container">
                                <a href={`/blog/other`} class="view-all-link">
                                    æŸ¥çœ‹æ‰€æœ‰å…¶ä»–æ–‡ç«  &rarr;
                                </a>
                            </div>
                        )}

                    </div>
                </>
            )}

        </div>
    </section>

    <section id="info" style="background-color: var(--color-gray-bg);">
    </section>

    <style>
        
        #blog-hero {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 20vh; /* (å»ºè­°æ‹‰é«˜ä¸€é») */
            padding: 3rem 1rem;
            
            /* (é—œéµ) 
            1. linear-gradient æ˜¯åŠ ä¸Š 40% çš„é»‘è‰²æ¼¸å±¤ (è®“ç™½å­—æ›´æ˜“è®€)
            2. url(...) æ˜¯æ‚¨åœ¨ public/images/ çš„åœ–ç‰‡è·¯å¾‘
            3. center center/cover è®“åœ–ç‰‡ç½®ä¸­ä¸”å¡«æ»¿ (ä¸è®Šå½¢)

            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), 
                        url('/images/blog-hero-cover.jpg') no-repeat center center/cover;
                        */

            /* (å¯é¸) è®“èƒŒæ™¯åœ–å›ºå®šä¸å‹•ï¼Œç”¢ç”Ÿè¦–å·®æ»¾å‹•æ•ˆæœ */
            background-attachment: fixed; 
            
            /* (é—œéµ) è®“å€å¡Šå…§çš„ "é è¨­" æ–‡å­— (å¦‚ P) è®Šæˆç™½è‰² */
            color: var(--color-white);
        }

        
        #blog-hero h1 {
            font-size: 2.5rem; /* æˆ–æ˜¯ä½ æƒ³è¦çš„å¤§å°ï¼Œä¾‹å¦‚ 3rem */
            color: var(--color-heading); /* ä¹Ÿå¯ä»¥é †ä¾¿çµ±ä¸€é¡è‰² */
            margin-bottom: 0.5rem; /* èª¿æ•´ä¸€ä¸‹è·Ÿåº•ä¸‹ <p> çš„é–“è· */
        }

        #blog-hero p {
            font-size: 1.1rem; /* æˆ–æ˜¯ä½ æƒ³è¦çš„å¤§å°ï¼Œä¾‹å¦‚ 3rem */
            color: var(--color-heading); /* ä¹Ÿå¯ä»¥é †ä¾¿çµ±ä¸€é¡è‰² */
            margin-bottom: 0.5rem; /* èª¿æ•´ä¸€ä¸‹è·Ÿåº•ä¸‹ <p> çš„é–“è· */
        }

        .category-title {
            font-size: 2rem;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 0.5rem;
            margin-bottom: 2rem;
            margin-top: 3rem;
        }
        .category-title:first-of-type {
            margin-top: 0;
        }

        /* New category layout: 1.5fr (featured) + 1fr (list) on desktop */
        .category-layout {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 2rem;
        }

        /* Base card style */
        .post-card {
            display: block;
            background: #fff;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
            text-decoration: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        /* Featured card styles (the large card) */
        .featured-card .card-image {
             height: 250px;
             width: 100%;
             object-fit: cover;
        }
        .featured-card .card-content {
             padding: 1.5rem;
        }
        .featured-card .card-content h3 {
            font-size: 1.75rem;
            margin: 0 0 0.5rem;
            color: var(--color-primary);
            text
        }
        .featured-card .card-content p {
            margin: 0 0 1rem;
            color: var(--color-text);
        }
        .featured-card .card-date {
            font-size: 0.9rem;
            color: #777;
        }

        /* List container for remaining posts */
        .list-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        /* ... (æ‚¨åŸæœ‰çš„ style æ¨™ç±¤å…§) ... */

        .view-all-container {
            /* è®“é€™å€‹é€£çµæ©«è·¨æ•´å€‹ .category-layout çš„åº•éƒ¨ */
            grid-column: 1 / -1;
            text-align: right;
            margin-top: 1rem;
        }
        .view-all-link {
            display: inline-block;
            font-weight: bold;
            color: var(--color-primary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .view-all-link:hover {
            background-color: var(--color-primary);
            color: #fff;
        }

        

        /* Individual list item styles */
        .list-item {
            display: block;
            text-decoration: none;
            border-bottom: 1px solid var(--color-border);
            padding: 1rem 0;
            transition: background-color 0.2s ease;
        }
        .list-item:first-of-type {
            padding-top: 0;
        }
        .list-item:last-of-type {
            border-bottom: none;
            padding-bottom: 0;
        }
        .list-item:hover {
            background-color: #f9f9f9;
        }

        .list-item-content h3 {
            font-size: 1.1rem;
            color: var(--color-text);
            margin: 0 0 0.25rem;
        }
        .list-item-date {
            font-size: 0.9rem;
            color: #777;
        }
 
        .update-badge {    /* Updated" badge style */
            color: #007A00; /* A green color for emphasis */
            font-weight: bold;
        }
        
        /* Responsive: On mobile, stack layout */
        @media (max-width: 768px) {
            .category-layout {
                grid-template-columns: 1fr;
            }
            .list-container {
                border-top: 2px solid var(--color-border);
                margin-top: 1rem;
                padding-top: 1rem;
            }
            .list-item:first-of-type {
                 padding-top: 0;
            }
            .featured-card .card-image {
                height: 200px;
            }
            .featured-card .card-content h3 {
                font-size: 1.5rem;
            }
        }

        /* Styles for your #info section */
        #info {
            background-color: var(--color-gray-bg);
        }
        #info .container {
            max-width: 1100px;
            margin: 0 auto;
        }
    </style>

</BaseLayout>