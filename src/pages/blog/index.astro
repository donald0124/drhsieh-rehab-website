---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

// (步驟 3.1：新增) 從 src/consts.ts 匯入
import { CATEGORY_MAP } from '../../consts.ts';



// 1. Get all posts and sort by the "most recent" date (lastMod or pubDate)
const allPosts: CollectionEntry<'blog'>[] = (await getCollection('blog')).sort(
    (a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => {
        const dateB = (b.data.lastMod ? b.data.lastMod : b.data.pubDate).valueOf();
        const dateA = (a.data.lastMod ? a.data.lastMod : a.data.pubDate).valueOf();
        return dateB - dateA;
    }
);


// 3. Filter posts based on their folder (ID)
const healthPosts = allPosts.filter(post => post.id.startsWith('health/'));
const reportPosts = allPosts.filter(post => post.id.startsWith('reports/'));
const directorPosts = allPosts.filter(post => post.id.startsWith('director/'));
const otherPosts = allPosts.filter(post => 
    !post.id.startsWith('health/') &&
    !post.id.startsWith('reports/') &&
    !post.id.startsWith('director/')
);

// 4. Split each category into "Latest" (1) and "Remaining" (up to 4)
const latestHealthPost = healthPosts[0];
const remainingHealthPosts = healthPosts.slice(1, 5); 

const latestReportPost = reportPosts[0];
const remainingReportPosts = reportPosts.slice(1, 5);

const latestDirectorPost = directorPosts[0];
const remainingDirectorPosts = directorPosts.slice(1, 5);

const latestOtherPost = otherPosts[0];
const remainingOtherPosts = otherPosts.slice(1, 5);

// Helper function to get the correct date to display
const getDisplayDate = (post: CollectionEntry<'blog'>) => {
    return post.data.lastMod ?? post.data.pubDate;
};
const hasBeenUpdated = (post: CollectionEntry<'blog'>) => {
    return post.data.lastMod ? true : false;
};
---

<BaseLayout title="專欄文章 | 謝明福復健科診所" description="診所最新衛教資訊、文章與媒體報導。">

    <section id="blog-hero" style="text-align: center; padding: 4rem 1rem; background-color: var(--color-primary-light);">
        <h1>衛教資訊 & 媒體報導</h1>
        <p>我們分享最新的復健知識、疼痛治療新知與媒體專訪。</p>
    </section>

    <section id="blog-list" style="padding: 4rem 1rem;">
        <div class="container" style="max-width: 900px; margin: 0 auto;">

            {latestHealthPost && (
                <>
                    <h2 class="category-title">{CATEGORY_MAP.health}</h2>
                    <div class="category-layout">
                        
                        <a href={`/blog/${latestHealthPost.slug}/`} class="featured-card post-card">
                            {latestHealthPost.data.heroImage && (
                                <img src={latestHealthPost.data.heroImage} alt={latestHealthPost.data.title} class="card-image">
                            )}
                            <div class="card-content">
                                <h3>{latestHealthPost.data.title}</h3>
                                <p>{latestHealthPost.data.description}</p>
                                <span class="card-date">
                                    {hasBeenUpdated(latestHealthPost) && <span class="update-badge">(已更新) </span>}
                                    {getDisplayDate(latestHealthPost).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                        </a>

                        <div class="list-container">
                            {remainingHealthPosts.map(post => (
                                <a href={`/blog/${post.slug}/`} class="list-item">
                                    <div class="list-item-content">
                                        <h3>{post.data.title}</h3>
                                        <span class="list-item-date">
                                            {hasBeenUpdated(post) && <span class="update-badge">(已更新) </span>}
                                            {getDisplayDate(post).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                        </span>
                                    </div>
                                </a>
                            ))}
                        </div>

                        {healthPosts.length > 5 && (
                            <div class="view-all-container">
                                <a href={`/blog/health`} class="view-all-link">
                                    查看所有「{CATEGORY_MAP.health}」文章 &rarr;
                                </a>
                            </div>
                        )}

                    </div>
                </>
            )}

            {latestReportPost && (
                <>
                    <h2 class="category-title">{CATEGORY_MAP.reports}</h2>
                    <div class="category-layout">
                        <a href={`/blog/${latestReportPost.slug}/`} class="featured-card post-card">
                            {latestReportPost.data.heroImage && (
                                <img src={latestReportPost.data.heroImage} alt={latestReportPost.data.title} class="card-image">
                            )}
                            <div class="card-content">
                                <h3>{latestReportPost.data.title}</h3>
                                <p>{latestReportPost.data.description}</p>
                                <span class="card-date">
                                    {hasBeenUpdated(latestReportPost) && <span class="update-badge">(已更新) </span>}
                                    {getDisplayDate(latestReportPost).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                        </a>
                        <div class="list-container">
                            {remainingReportPosts.map(post => (
                                <a href={`/blog/${post.slug}/`} class="list-item">
                                    <div class="list-item-content">
                                        <h3>{post.data.title}</h3>
                                        <span class="list-item-date">
                                            {hasBeenUpdated(post) && <span class="update-badge">(已更新) </span>}
                                            {getDisplayDate(post).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                        </span>
                                    </div>
                                </a>
                            ))}
                        </div>

                        {reportPosts.length > 5 && (
                            <div class="view-all-container">
                                <a href={`/blog/report`} class="view-all-link">
                                    查看所有「{CATEGORY_MAP.reports}」文章 &rarr;
                                </a>
                            </div>
                        )}

                    </div>
                </>
            )}

            {latestDirectorPost && (
                <>
                    <h2 class="category-title">{CATEGORY_MAP.director}</h2>
                    <div class="category-layout">
                        <a href={`/blog/${latestDirectorPost.slug}/`} class="featured-card post-card">
                            {latestDirectorPost.data.heroImage && (
                                <img src={latestDirectorPost.data.heroImage} alt={latestDirectorPost.data.title} class="card-image">
                            )}
                            <div class="card-content">
                                <h3>{latestDirectorPost.data.title}</h3>
                                <p>{latestDirectorPost.data.description}</p>
                                <span class="card-date">
                                    {hasBeenUpdated(latestDirectorPost) && <span class="update-badge">(已更新) </span>}
                                    {getDisplayDate(latestDirectorPost).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                        </a>
                        <div class="list-container">
                            {remainingDirectorPosts.map(post => (
                                <a href={`/blog/${post.slug}/`} class="list-item">
                                    <div class="list-item-content">
                                        <h3>{post.data.title}</h3>
                                        <span class="list-item-date">
                                            {hasBeenUpdated(post) && <span class="update-badge">(已更新) </span>}
                                            {getDisplayDate(post).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                        </span>
                                    </div>
                                </a>
                            ))}
                        </div>

                        {directorPosts.length > 5 && (
                            <div class="view-all-container">
                                <a href={`/blog/director`} class="view-all-link">
                                    查看所有「{CATEGORY_MAP.director}」文章 &rarr;
                                </a>
                            </div>
                        )}

                    </div>
                </>
            )}
            
            {latestOtherPost && (
                <>
                    <h2 class="category-title">其他文章</h2>
                    <div class="category-layout">
                        <a href={`/blog/${latestOtherPost.slug}/`} class="featured-card post-card">
                            {latestOtherPost.data.heroImage && (
                                <img src={latestOtherPost.data.heroImage} alt={latestOtherPost.data.title} class="card-image">
                            )}
                            <div class="card-content">
                                <h3>{latestOtherPost.data.title}</h3>
                                <p>{latestOtherPost.data.description}</p>
                                <span class="card-date">
                                    {hasBeenUpdated(latestOtherPost) && <span class="update-badge">(已更新) </span>}
                                    {getDisplayDate(latestOtherPost).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                        </a>
                        <div class="list-container">
                            {remainingOtherPosts.map(post => (
                                <a href={`/blog/${post.slug}/`} class="list-item">
                                    <div class="list-item-content">
                                        <h3>{post.data.title}</h3>
                                        <span class="list-item-date">
                                            {hasBeenUpdated(post) && <span class="update-badge">(已更新) </span>}
                                            {getDisplayDate(post).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                                        </span>
                                    </div>
                                </a>
                            ))}
                        </div>

                        {otherPosts.length > 5 && (
                            <div class="view-all-container">
                                <a href={`/blog/other`} class="view-all-link">
                                    查看所有其他文章 &rarr;
                                </a>
                            </div>
                        )}

                    </div>
                </>
            )}

        </div>
    </section>

    <section id="info" style="background-color: var(--color-gray-bg);">
    </section>

    <style>
        .category-title {
            font-size: 2rem;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 0.5rem;
            margin-bottom: 2rem;
            margin-top: 3rem;
        }
        .category-title:first-of-type {
            margin-top: 0;
        }

        /* New category layout: 1.5fr (featured) + 1fr (list) on desktop */
        .category-layout {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 2rem;
        }

        /* Base card style */
        .post-card {
            display: block;
            background: #fff;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
            text-decoration: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        /* Featured card styles (the large card) */
        .featured-card .card-image {
             height: 250px;
             width: 100%;
             object-fit: cover;
        }
        .featured-card .card-content {
             padding: 1.5rem;
        }
        .featured-card .card-content h3 {
            font-size: 1.75rem;
            margin: 0 0 0.5rem;
            color: var(--color-primary);
        }
        .featured-card .card-content p {
            margin: 0 0 1rem;
            color: var(--color-text);
        }
        .featured-card .card-date {
            font-size: 0.9rem;
            color: #777;
        }

        /* List container for remaining posts */
        .list-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        /* ... (您原有的 style 標籤內) ... */

        .view-all-container {
            /* 讓這個連結橫跨整個 .category-layout 的底部 */
            grid-column: 1 / -1; 
            text-align: right;
            margin-top: 1rem;
        }
        .view-all-link {
            display: inline-block;
            font-weight: bold;
            color: var(--color-primary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .view-all-link:hover {
            background-color: var(--color-primary);
            color: #fff;
        }

        

        /* Individual list item styles */
        .list-item {
            display: block;
            text-decoration: none;
            border-bottom: 1px solid var(--color-border);
            padding: 1rem 0;
            transition: background-color 0.2s ease;
        }
        .list-item:first-of-type {
            padding-top: 0;
        }
        .list-item:last-of-type {
            border-bottom: none;
            padding-bottom: 0;
        }
        .list-item:hover {
            background-color: #f9f9f9;
        }

        .list-item-content h3 {
            font-size: 1.1rem;
            color: var(--color-text);
            margin: 0 0 0.25rem;
        }
        .list-item-date {
            font-size: 0.9rem;
            color: #777;
        }
        
        /* "(Updated)" badge style */
        .update-badge {
            color: #007A00; /* A green color for emphasis */
            font-weight: bold;
        }
        
        /* Responsive: On mobile, stack layout */
        @media (max-width: 768px) {
            .category-layout {
                grid-template-columns: 1fr;
            }
            .list-container {
                border-top: 2px solid var(--color-border);
                margin-top: 1rem;
                padding-top: 1rem;
            }
            .list-item:first-of-type {
                 padding-top: 0;
            }
            .featured-card .card-image {
                height: 200px;
            }
            .featured-card .card-content h3 {
                font-size: 1.5rem;
            }
        }

        /* Styles for your #info section */
        #info {
            background-color: var(--color-gray-bg);
        }
        #info .container {
            max-width: 1100px;
            margin: 0 auto;
        }
    </style>

</BaseLayout>