---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import CallToAction from "../../components/CallToAction.astro";
import TableOfContents from "../../components/TableOfContents.astro";
import BlogPreview from "../../components/BlogPreview.astro";

// 1. 產生所有文章的靜態路徑
export async function getStaticPaths() {
    const allPosts = await getCollection("blog");

    // 幫 'post' 加上型別
    return allPosts.map((post: CollectionEntry<"blog">) => ({
        params: { slug: post.slug },
        props: { post },
    }));
}

// 2. 幫傳入的 props 定義型別
interface Props {
    post: CollectionEntry<"blog">;
}

// 3. 取得這篇文章的資料
const { post } = Astro.props;
const { Content, headings } = await post.render();

// 4. 計算閱讀時間 (簡單估算：中文字數 / 300)
const wordCount = post.body.length;
const readingTime = Math.ceil(wordCount / 300);

// 5. 相關文章推薦演算法 (基於 Tags 的加權計分)
const allPosts = await getCollection("blog");
const currentTags = post.data.tags || []; // 取得當前文章的標籤，若無則設為空陣列

// 5.1 計算每篇文章的關聯分數
const scoredPosts = allPosts
    .filter((p: CollectionEntry<"blog">) => p.slug !== post.slug) // 排除當前文章
    .map((p: CollectionEntry<"blog">) => {
        const postTags = p.data.tags || [];
        // 計算這篇文章與當前文章有幾個相同的標籤 (+1 分)
        const score = postTags.reduce((acc, tag) => {
            return currentTags.includes(tag) ? acc + 1 : acc;
        }, 0);

        return { post: p, score };
    });

// 5.2 依照分數與日期進行排序
scoredPosts.sort((a, b) => {
    // 條件一：先比分數 (由高到低)
    if (b.score !== a.score) {
        return b.score - a.score;
    }
    // 條件二：若分數相同，加入隨機性 (讓同分群的文章輪流曝光)
    return Math.random() - 0.5;
});

// 5.3 取得前 3 篇最高分的文章
// (建議固定取 3 篇，因為 3 篇在電腦版剛好可以排成漂亮的一列 Grid)
const recommendedPosts = scoredPosts.slice(0, 3).map((item) => item.post);

const lastModified = post.data.updatedDate || post.data.lastMod;
---

<BaseLayout
    title={post.data.title}
    description={post.data.description}
    ogImage={post.data.heroImage}
>
    <header class="pt-12 pb-8 md:pt-20 md:pb-12 text-center px-4">
        <div class="max-w-4xl mx-auto">
            <h1
                class="text-3xl md:text-5xl font-extrabold text-heading leading-tight mb-6"
            >
                {post.data.title}
            </h1>

            {
                post.data.description && (
                    <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto mb-8 leading-relaxed">
                        {post.data.description}
                    </p>
                )
            }

            <div
                class="flex flex-wrap items-center justify-center gap-x-6 gap-y-3 text-sm md:text-base text-gray-500 mb-10"
            >
                <div class="flex items-center gap-2">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="text-primary"
                        ><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"
                        ></path><circle cx="12" cy="7" r="4"></circle></svg
                    >
                    <span class="font-bold text-primary"
                        >{post.data.author || "謝明福 院長"}</span
                    >
                </div>

                <span class="hidden md:inline text-gray-300">|</span>

                <div class="flex items-center gap-2">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><rect width="18" height="18" x="3" y="4" rx="2" ry="2"
                        ></rect><line x1="16" x2="16" y1="2" y2="6"></line><line
                            x1="8"
                            x2="8"
                            y1="2"
                            y2="6"></line><line x1="3" x2="21" y1="10" y2="10"
                        ></line></svg
                    >
                    <span>
                        {
                            lastModified ? (
                                <span class="font-medium">
                                    更新於{" "}
                                    {lastModified.toLocaleDateString("zh-TW", {
                                        year: "numeric",
                                        month: "long",
                                        day: "numeric",
                                    })}
                                </span>
                            ) : (
                                <span>
                                    發布於{" "}
                                    {post.data.pubDate.toLocaleDateString(
                                        "zh-TW",
                                        {
                                            year: "numeric",
                                            month: "long",
                                            day: "numeric",
                                        },
                                    )}
                                </span>
                            )
                        }
                    </span>
                </div>

                <span class="hidden md:inline text-gray-300">|</span>

                <div class="flex items-center gap-2 font-medium">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><circle cx="12" cy="12" r="10"></circle><polyline
                            points="12 6 12 12 16 14"></polyline></svg
                    >
                    <span>閱讀時間 {readingTime} 分鐘</span>
                </div>
            </div>
        </div>

        {
            post.data.heroImage && (
                <div class="max-w-4xl mx-auto mt-2 px-2 md:px-0">
                    <img
                        src={post.data.heroImage}
                        alt={post.data.title}
                        class="w-full h-auto aspect-video object-cover rounded-2xl shadow-lg border border-gray-100"
                    />
                </div>
            )
        }
    </header>

    <section id="article-content" style="padding: 3rem 2rem;">
        <div class="blog-grid-container">
            <!-- Mobile TOC (Hidden on desktop via CSS) -->
            <div class="mobile-only-toc">
                <TableOfContents headings={headings} accordion={true} />
            </div>
            <article
                class="prose prose-lg max-w-none blog-main"
                style="line-height: 1.8;"
            >
                <Content />
            </article>

            <!-- Sidebar TOC (Visible on desktop via CSS) -->
            <aside class="blog-sidebar">
                <div class="sticky-toc">
                    <TableOfContents headings={headings} />
                </div>
            </aside>
        </div>
    </section>

    <CallToAction />

    <!-- 返回文章列表 -->
    <div style="text-align: center; padding: 2rem 1rem 2rem;">
        <a href="/blog/" class="cta-button">返回文章列表</a>
    </div>

    {
        recommendedPosts.length > 0 && (
            <section class="mt-16 pt-10 border-t border-gray-100">
                <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-4 mb-6">
                    <h3 class="text-2xl font-bold text-heading flex items-center gap-2">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="text-primary"
                        >
                            <>
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                            </>
                        </svg>
                        為您推薦的相關文章
                    </h3>

                    <a
                        href="/blog/"
                        class="inline-flex items-center gap-1 text-sm font-semibold text-primary hover:text-primary-dark transition-colors bg-primary-light hover:bg-blue-100 px-4 py-2 rounded-full"
                    >
                        查看所有文章
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <>
                                <path d="M5 12h14" />
                                <path d="m12 5 7 7-7 7" />
                            </>
                        </svg>
                    </a>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                    {recommendedPosts.map((post) => (
                        <BlogPreview post={post} />
                    ))}
                </div>
            </section>
        )
    }

    <!-- Scoped Styles for Grid Layout -->
    <style>
        /* Mobile First: Default Layout */
        .blog-grid-container {
            width: 100%;
            max-width: 800px; /* Limit width on mobile/single column */
            margin: 0 auto;
            position: relative;
        }

        .blog-main {
            width: 100%;
        }

        /* Hide Sidebar by default on Mobile */
        .blog-sidebar {
            display: none;
        }

        .mobile-only-toc {
            display: block;
            margin-bottom: 2rem;
        }

        /* Desktop Layout (Large Screens) */
        @media (min-width: 1024px) {
            .blog-grid-container {
                display: grid;
                /* Main Content (70-75%) | Sidebar (Remaining) */
                grid-template-columns: 3fr 1fr;
                gap: 3rem;
                max-width: 1200px; /* Increase container width for side-by-side */
            }

            .blog-main {
                /* Remove max-width restriction inside grid */
                max-width: 100%;
                /* Ensure it takes full width of grid cell */
                width: 100%;
            }

            .mobile-only-toc {
                display: none; /* Hide top TOC on desktop */
            }

            .blog-sidebar {
                display: block; /* Show sidebar */
                height: 100%; /* Full height container */
            }

            .sticky-toc {
                position: sticky;
                top: 100px; /* Sticky positioning as requested */
                max-height: calc(100vh - 120px); /* Prevent overflow */
                overflow-y: auto; /* Scrollable if TOC is too long */
            }
        }
    </style>
</BaseLayout>
