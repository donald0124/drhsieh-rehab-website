---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
// import CallToAction from "../../components/CallToAction.astro";
// 1. 產生所有文章的靜態路徑
export async function getStaticPaths() {
    const allPosts = await getCollection("blog");

    // 幫 'post' 加上型別
    return allPosts.map((post: CollectionEntry<"blog">) => ({
        params: { slug: post.slug },
        props: { post },
    }));
}

// 2. 幫傳入的 props 定義型別
interface Props {
    post: CollectionEntry<"blog">;
}

// 3. 取得這篇文章的資料
const { post } = Astro.props;
const { Content, headings } = await post.render();

// 4. 計算閱讀時間 (簡單估算：中文字數 / 300)
const wordCount = post.body.length;
const readingTime = Math.ceil(wordCount / 300);

// 5. 取得所有文章，並隨機推薦 3-5 篇（排除當前文章）
const allPosts = await getCollection("blog");
const otherPosts = allPosts
    .filter((p: CollectionEntry<"blog">) => p.slug !== post.slug) // 排除當前文章
    .sort(() => Math.random() - 0.5); // 隨機排序

// 隨機取 3-5 篇
const randomCount = Math.min(
    3 + Math.floor(Math.random() * 3),
    otherPosts.length,
);
const recommendedPosts = otherPosts.slice(0, randomCount);
const lastModified = post.data.updatedDate || post.data.lastMod;

import TableOfContents from "../../components/TableOfContents.astro";
---

<BaseLayout
    title={post.data.title}
    description={post.data.description}
    ogImage={post.data.heroImage}
>
    <section
        id="article-header"
        style="text-align: center; padding: 4rem 1rem; background-color: var(--color-primary-light);"
    >
        <h1
            style="font-size: 2.8rem; margin-bottom: 1.5rem; font-weight: 800; color: var(--color-heading);"
        >
            {post.data.title}
        </h1>

        <p
            style="font-size: 1.25rem; color: var(--color-text); max-width: 700px; margin: 0 auto 1.5rem;"
        >
            {post.data.description}
        </p>

        <p
            style="font-size: 1.1rem; color: var(--color-primary); font-weight: bold; margin: 0 auto 0.5rem;"
        >
            {post.data.author || "謝明福 院長"}
        </p>

        <p style="font-size: 1rem; color: var(--color-text);">
            發布日期: {
                post.data.pubDate.toLocaleDateString("zh-TW", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                })
            }

            {
                lastModified && (
                    <span style="color: #007A00; margin-left: 1rem; font-weight: bold;">
                        (更新於:{" "}
                        {lastModified.toLocaleDateString("zh-TW", {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        })}
                        )
                    </span>
                )
            }

            <span style="margin-left: 1rem; color: var(--color-text);">
                閱讀時間約 {readingTime} 分鐘
            </span>
        </p>

        {
            post.data.heroImage && (
                <img
                    src={post.data.heroImage}
                    alt={post.data.title}
                    style="
                width: 100%; 
                max-width: 900px; 
                margin: 2rem auto 0; /* <-- 修改點 */
                border-radius: 8px;
            "
                />
            )
        }
    </section>

    <section id="article-content" style="padding: 3rem 2rem;">
        <div class="blog-grid-container">
            <!-- Mobile TOC (Hidden on desktop via CSS) -->
            <div class="mobile-only-toc">
                <TableOfContents headings={headings} accordion={true} />
            </div>
            <article
                class="prose prose-lg max-w-none blog-main"
                style="line-height: 1.8;"
            >
                <Content />
            </article>

            <!-- Sidebar TOC (Visible on desktop via CSS) -->
            <aside class="blog-sidebar">
                <div class="sticky-toc">
                    <TableOfContents headings={headings} />
                </div>
            </aside>
        </div>
    </section>

    <!-- <CallToAction /> -->

    <!-- 推薦文章區塊 -->
    <section
        id="recommended-posts"
        style="padding: 4rem 1rem; background-color: #f9fafb; margin-top: 4rem;"
    >
        <div style="max-width: 1000px; margin: 0 auto;">
            <h2
                style="text-align: center; font-size: 2rem; margin-bottom: 3rem; color: #1f2937;"
            >
                你可能也喜歡
            </h2>

            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem;"
            >
                {
                    recommendedPosts.map((recommendedPost) => (
                        <a
                            href={`/blog/${recommendedPost.slug}/`}
                            style="
                            text-decoration: none;
                            color: inherit;
                            background: white;
                            border-radius: 8px;
                            overflow: hidden;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            transition: transform 0.3s ease, box-shadow 0.3s ease;
                            display: flex;
                            flex-direction: column;
                            height: 100%;
                        "
                            onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0, 0, 0, 0.15)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.1)';"
                        >
                            {recommendedPost.data.heroImage && (
                                <img
                                    src={recommendedPost.data.heroImage}
                                    alt={recommendedPost.data.title}
                                    style="width: 100%; height: 180px; object-fit: cover;"
                                />
                            )}
                            <div style="padding: 1.5rem; flex: 1; display: flex; flex-direction: column;">
                                <h3 style="font-size: 1.2rem; margin: 0 0 0.75rem; color: #1f2937; line-height: 1.4;">
                                    {recommendedPost.data.title}
                                </h3>
                                <p style="font-size: 0.95rem; color: #6b7280; margin: 0 0 1rem; flex: 1; line-height: 1.5;">
                                    {recommendedPost.data.description}
                                </p>
                                <p style="font-size: 0.85rem; color: #9ca3af; margin: 0;">
                                    {recommendedPost.data.pubDate.toLocaleDateString(
                                        "zh-TW",
                                        {
                                            year: "numeric",
                                            month: "long",
                                            day: "numeric",
                                        },
                                    )}
                                </p>
                            </div>
                        </a>
                    ))
                }
            </div>
        </div>
    </section>

    <div style="text-align: center; padding: 2rem 1rem 4rem;">
        <a href="/blog/" class="cta-button">返回文章列表</a>
    </div>

    <!-- Scoped Styles for Grid Layout -->
    <style>
        /* Mobile First: Default Layout */
        .blog-grid-container {
            width: 100%;
            max-width: 800px; /* Limit width on mobile/single column */
            margin: 0 auto;
            position: relative;
        }

        .blog-main {
            width: 100%;
        }

        /* Hide Sidebar by default on Mobile */
        .blog-sidebar {
            display: none;
        }

        .mobile-only-toc {
            display: block;
            margin-bottom: 2rem;
        }

        /* Desktop Layout (Large Screens) */
        @media (min-width: 1024px) {
            .blog-grid-container {
                display: grid;
                /* Main Content (70-75%) | Sidebar (Remaining) */
                grid-template-columns: 3fr 1fr;
                gap: 3rem;
                max-width: 1200px; /* Increase container width for side-by-side */
            }

            .blog-main {
                /* Remove max-width restriction inside grid */
                max-width: 100%;
                /* Ensure it takes full width of grid cell */
                width: 100%;
            }

            .mobile-only-toc {
                display: none; /* Hide top TOC on desktop */
            }

            .blog-sidebar {
                display: block; /* Show sidebar */
                height: 100%; /* Full height container */
            }

            .sticky-toc {
                position: sticky;
                top: 100px; /* Sticky positioning as requested */
                max-height: calc(100vh - 120px); /* Prevent overflow */
                overflow-y: auto; /* Scrollable if TOC is too long */
            }
        }
    </style>
</BaseLayout>
