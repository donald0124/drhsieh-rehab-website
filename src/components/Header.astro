<header
    id="main-header"
    class="sticky top-0 w-full z-[1000] transition-all duration-300 bg-white/90 backdrop-blur-md shadow-sm"
>
    <nav class="navbar" aria-label="主要導覽">
        <a href="/" class="logo" aria-label="回到首頁">
            <img
                src="/drhsieh-rehab-logo.svg"
                alt="謝明福復健科診所 Logo"
                width="200"
                height="40"
                class="h-10 w-auto"
            />
        </a>

        <button
            id="menu-toggle"
            class="hamburger md:hidden"
            aria-label="開啟選單"
            aria-expanded="false"
            aria-controls="primary-navigation"
        >
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </button>

        <ul id="primary-navigation" class="nav-menu">
            <li>
                <a href="/#patient-info" class="nav-cta-button">就診資訊</a>
            </li>
            <li><a href="/#about-us">關於我們</a></li>
            <li><a href="/#team">醫師介紹</a></li>

            <li class="dropdown-item group">
                <a
                    href="/#services"
                    class="dropdown-title flex items-center gap-1"
                >
                    主治項目 <span
                        class="arrow transition-transform group-hover:rotate-180"
                        >▾</span
                    >
                </a>

                <ul class="dropdown-menu">
                    <li>
                        <a href="/#services">主治項目總覽</a>
                    </li>
                    <li>
                        <a href="/blog/neims/">針極肌肉內電刺激 (NEIMS)</a>
                    </li>
                    <li>
                        <a href="/blog/superlizer/"
                            >直線偏極光治療 (Superlizer)</a
                        >
                    </li>
                </ul>
            </li>

            <li><a href="/blog/">專欄文章</a></li>

            <li class="nav-social-container">
                <a
                    href="https://line.me/R/ti/p/@gsj9393s"
                    target="_blank"
                    class="social-icon"
                    title="LINE"
                    aria-label="加入 LINE 好友"
                >
                    <img
                        src="/LINE_icon.svg"
                        alt=""
                        width="36"
                        height="36"
                        loading="lazy"
                    />
                </a>
                <a
                    href="https://www.facebook.com/Top.rehabilitation.center"
                    target="_blank"
                    class="social-icon"
                    title="Facebook"
                    aria-label="前往 Facebook 粉絲專頁"
                >
                    <img
                        src="/Facebook_icon.svg"
                        alt=""
                        width="36"
                        height="36"
                        loading="lazy"
                    />
                </a>
            </li>
        </ul>
    </nav>

    <!-- Mobile Menu Overlay Background -->
    <div
        id="menu-overlay"
        class="fixed inset-0 bg-black/50 z-[900] hidden opacity-0 transition-opacity duration-300 md:hidden"
        aria-hidden="true"
    >
    </div>
</header>

<script>
    // 使用 ES6 Module 寫法，避免全局污染
    const header = document.getElementById("main-header");
    const toggleButton = document.getElementById("menu-toggle");
    const navMenu = document.getElementById("primary-navigation");
    const overlay = document.getElementById("menu-overlay");

    if (toggleButton && navMenu && overlay) {
        // Toggle Menu Function
        const toggleMenu = () => {
            const isExpanded =
                toggleButton.getAttribute("aria-expanded") === "true";

            // UI Update
            toggleButton.classList.toggle("is-active");
            navMenu.classList.toggle("active");

            // Accessibility Update
            toggleButton.setAttribute(
                "aria-expanded",
                (!isExpanded).toString(),
            );

            // Overlay Toggle
            if (!isExpanded) {
                overlay.classList.remove("hidden");
                // Small delay to allow display:block to apply before opacity transition
                requestAnimationFrame(() => {
                    overlay.classList.remove("opacity-0");
                });
                document.body.style.overflow = "hidden"; // Prevent background scrolling
            } else {
                overlay.classList.add("opacity-0");
                setTimeout(() => {
                    overlay.classList.add("hidden");
                }, 300); // Match transition duration
                document.body.style.overflow = "";
            }
        };

        toggleButton.addEventListener("click", toggleMenu);
        overlay.addEventListener("click", toggleMenu); // Click outside to close

        // Close menu when clicking a link
        navMenu.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", () => {
                if (navMenu.classList.contains("active")) {
                    toggleMenu();
                }
            });
        });

        // Scroll Effect (Optional: Add shadow on scroll)
        // const updateHeaderShadow = () => {
        //     if (window.scrollY > 10) {
        //         header?.classList.add("shadow-md");
        //         header?.classList.remove("shadow-sm");
        //     } else {
        //         header?.classList.remove("shadow-md");
        //         header?.classList.add("shadow-sm");
        //     }
        // };
        // window.addEventListener("scroll", updateHeaderShadow, { passive: true });
    }
</script>

<style>
    /* 
     * Header & Navbar Layout 
     * 使用 Tailwind Utility 為主，這裡保留特定自定義樣式
     */
    .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        max-width: var(--container-width);
        margin: 0 auto;
        height: 70px; /* Mobile Height */
    }

    .navbar .logo img {
        height: 40px;
        width: auto;
        display: block;
    }

    /* --- Hamburger Button --- */
    .hamburger {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        width: 30px;
        height: 20px; /* Slightly tighter height */
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        z-index: 1100;
        /* Increase touch target */
        position: relative;
    }

    /* Touch target expansion pseudo-element */
    .hamburger::after {
        content: "";
        position: absolute;
        top: -10px;
        right: -10px;
        bottom: -10px;
        left: -10px;
    }

    .hamburger .bar {
        width: 100%;
        height: 2.5px; /* Thinner lines */
        background-color: var(--color-heading);
        border-radius: 99px;
        transition:
            transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.3s ease;
        transform-origin: center;
    }

    /* Animated State (X) */
    .hamburger.is-active .bar:nth-child(1) {
        transform: translateY(9px) rotate(45deg);
    }
    .hamburger.is-active .bar:nth-child(2) {
        opacity: 0;
        transform: translateX(10px);
    }
    .hamburger.is-active .bar:nth-child(3) {
        transform: translateY(-8.5px) rotate(-45deg);
    }

    /* --- Mobile Navigation Menu --- */
    .nav-menu {
        position: absolute;
        top: 70px; /* Header Height */
        left: 0;
        width: 100%;
        background-color: white;
        flex-direction: column;
        align-items: center;
        padding: 1rem 0 2rem;
        border-top: 1px solid #f3f4f6;

        display: none; /* Hidden by default */
        opacity: 0;
        transform: translateY(-10px);
        transition:
            opacity 0.3s ease,
            transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
        max-height: calc(100vh - 70px);
        overflow-y: auto;
    }

    .nav-menu.active {
        display: flex;
        opacity: 1;
        transform: translateY(0);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* Mobile Menu Items */
    .nav-menu li {
        width: 100%;
        text-align: center;
        list-style: none;
    }

    .nav-menu > li > a:not(.nav-cta-button):not(.social-icon) {
        display: block;
        padding: 1rem;
        text-decoration: none;
        color: var(--color-text);
        font-weight: 500;
        border-bottom: 1px solid #f9fafb;
    }

    .dropdown-title {
        display: flex;
        justify-content: center;
        width: 100%;
        padding: 1rem;
        font-weight: 500;
        cursor: pointer;
    }

    /* Mobile Dropdown (Directly visible or indented) */
    .dropdown-menu {
        display: flex;
        flex-wrap: wrap;
        padding: 0.5rem 1rem;
        background-color: #f9fafb;
        gap: 0.5rem;
        justify-content: center;
    }

    .dropdown-menu li {
        width: auto;
        flex: 1 1 45%; /* Two columns roughly */
    }

    .dropdown-menu li a {
        display: block;
        padding: 0.5rem 0.25rem;
        font-size: 0.9rem;
        color: #6b7280;
        text-align: center;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        background: white;
    }

    /* CTA Button (Mobile) */
    .nav-cta-button {
        display: inline-block !important;
        background-color: var(--color-primary);
        color: white !important;
        padding: 0.75rem 2rem !important;
        border-radius: 9999px;
        margin-top: 1.5rem;
        font-weight: 600;
        box-shadow: 0 4px 6px -1px rgba(var(--color-primary-rgb), 0.3);
    }

    /* Social Icons (Mobile) */
    .nav-social-container {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 1.5rem;
        padding-bottom: 1rem;
    }

    /* =========================================
       Desktop Styles (>= 1024px)
       ========================================= */
    @media (min-width: 1024px) {
        .navbar {
            padding: 0 2rem;
            height: 80px;
        }

        .hamburger {
            display: none;
        }

        /* Desktop Nav Menu Reset */
        .nav-menu {
            position: static;
            display: flex;
            flex-direction: row;
            width: auto;
            height: auto;
            padding: 0;
            border: none;
            background: transparent;
            box-shadow: none;
            opacity: 1;
            transform: none;
            gap: 2rem;
            overflow: visible;
        }

        .nav-menu li {
            width: auto;
        }

        .nav-menu > li > a:not(.nav-cta-button):not(.social-icon),
        .dropdown-title {
            padding: 0.5rem 0;
            border: none;
            font-size: 1rem;
            color: var(--color-text);
            position: relative;
        }

        /* Hover Line Effect */
        .nav-menu > li > a:not(.nav-cta-button):not(.social-icon)::after,
        .dropdown-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--color-primary);
            transition: width 0.3s ease;
        }

        .nav-menu > li > a:not(.nav-cta-button):not(.social-icon):hover::after,
        .dropdown-title:hover::after {
            width: 100%;
        }

        .nav-menu > li > a:hover,
        .dropdown-title:hover {
            color: var(--color-primary);
        }

        /* Desktop Dropdown */
        .dropdown-item {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            width: 260px;
            background: white;
            flex-direction: column;
            padding: 0.5rem 0;
            border: 1px solid #f3f4f6;
            border-radius: 0.5rem;
            box-shadow:
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100; /* Dropdown z-index */
        }

        /* Bridge to keep hover active */
        .dropdown-item::before {
            content: "";
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            height: 20px; /* Bridge height */
        }

        .dropdown-item:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .dropdown-menu li {
            width: 100%;
        }

        .dropdown-menu li a {
            display: block;
            text-align: left;
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            font-size: 0.95rem;
            color: var(--color-text);
            transition: background-color 0.2s;
        }

        .dropdown-menu li a:hover {
            background-color: #f9fafb;
            color: var(--color-primary);
        }

        /* Desktop CTA Button */
        .nav-cta-button {
            margin-top: 0;
            padding: 0.6rem 1.5rem !important;
            font-size: 0.95rem;
            transition:
                transform 0.2s,
                background-color 0.2s;
        }

        .nav-cta-button:hover {
            transform: translateY(-2px);
            background-color: var(--color-primary-dark);
        }

        /* Desktop Social Icons */
        .nav-social-container {
            margin-top: 0;
            padding-bottom: 0;
            gap: 1rem;
        }

        .social-icon img {
            width: 28px;
            height: 28px;
            opacity: 0.8;
            transition:
                opacity 0.2s,
                transform 0.2s;
        }

        .social-icon:hover img {
            opacity: 1;
            transform: translateY(-2px);
        }

        .nav-menu {
            align-items: center; /* Center align items vertically */
        }
    }
</style>
