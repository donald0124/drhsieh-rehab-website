---
import type { CollectionEntry } from "astro:content";

interface Props {
    post: CollectionEntry<"blog">;
}

const { post } = Astro.props;

// 1 & 2. 封面圖片降級策略 (Fallback Logic)
let coverImage = post.data.heroImage;

if (!coverImage && post.body) {
    // 若無封面圖，用 Regex 尋找 Markdown 內文中的第一張圖片
    // 匹配 ![alt](url) 或是 <img src="url">
    const mdImageMatch = post.body.match(/!\[.*?\]\((.*?)\)/);
    const htmlImageMatch = post.body.match(/<img.*?src=["'](.*?)["']/);

    if (mdImageMatch) {
        coverImage = mdImageMatch[1];
    } else if (htmlImageMatch) {
        coverImage = htmlImageMatch[1];
    }
}

// 擷取描述文字 (作為無圖時的文字卡片內容)
const descriptionSnippet = post.data.description
    ? post.data.description
    : "這篇文章探討了復健科常見的臨床症狀與精準治療方式，歡迎點擊閱讀詳細內容。";

// 4. 日期顯示邏輯 (有更新時間則優先顯示)
const isUpdated = !!(post.data.updatedDate || post.data.lastMod);
const displayDate =
    post.data.updatedDate || post.data.lastMod || post.data.pubDate;
---

<div class="block group h-full relative">
    <div
        class="bg-white rounded-xl border border-gray-100 overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 h-full flex flex-col"
    >
        <a
            href={`/blog/${post.slug}/`}
            class="aspect-video w-full overflow-hidden bg-gray-50 relative block"
        >
            {
                post.data.featured && (
                    <div class="absolute top-3 right-3 bg-primary-dark opacity-85 text-white text-xs font-bold px-2.5 py-1 rounded-md shadow-sm z-20 flex items-center gap-1 backdrop-blur-sm">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="12"
                            height="12"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                            stroke="none"
                        >
                            <path d="M16 11.78L20.24 16H13v6h-2v-6H3.76L8 11.78V6A2 2 0 0 1 10 4h4a2 2 0 0 1 2 2v5.78z" />
                        </svg>
                        置頂
                    </div>
                )
            }
            {
                coverImage ? (
                    <img
                        src={coverImage}
                        alt={post.data.title}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                    />
                ) : (
                    <div class="w-full h-full p-6 flex flex-col items-center justify-center bg-gradient-to-br from-primary-light to-blue-100 text-primary-dark group-hover:scale-105 transition-transform duration-500">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="opacity-40 mb-2"
                        >
                            <>
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                            </>
                        </svg>
                        <p class="text-sm md:text-base text-center font-medium line-clamp-3 leading-relaxed opacity-80">
                            {descriptionSnippet}
                        </p>
                    </div>
                )
            }
            }
        </a>

        <div class="p-5 flex flex-col flex-grow relative">
            <div
                class="flex flex-nowrap gap-2 mb-3 overflow-hidden relative z-10 w-full overflow-x-auto scrollbar-hide"
            >
                {
                    post.data.tags?.map((tag) => (
                        <a
                            href={`/blog/?tag=${tag}`}
                            class="text-xs font-medium text-primary bg-primary-light px-2.5 py-1 rounded-full whitespace-nowrap hover:bg-primary hover:text-white transition-colors z-20 relative"
                        >
                            {tag}
                        </a>
                    ))
                }
                <div
                    class="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-white to-transparent z-10 pointer-events-none"
                >
                </div>
            </div>

            <a href={`/blog/${post.slug}/`} class="block">
                <h4
                    class="text-lg font-bold text-heading mb-2 line-clamp-2 group-hover:text-primary transition-colors"
                >
                    {post.data.title}
                </h4>
            </a>

            <div class="mt-auto pt-4 flex items-center text-sm text-gray-500">
                <span>
                    {
                        isUpdated && (
                            <span class="text-green-600 font-medium mr-1" />
                        )
                    }
                    {
                        displayDate.toLocaleDateString("zh-TW", {
                            year: "numeric",
                            month: "short",
                            day: "numeric",
                        })
                    }
                </span>
            </div>
        </div>
    </div>
</div>

<style>
    /* 隱藏橫向滾動條，但保留滑動功能 */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
    }
</style>
